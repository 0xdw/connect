<!DOCTYPE html><html><head><title>Connect - High quality middleware for node.js</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><link rel="stylesheet" href="style.css"><script src="jquery.js"></script><script src="docs.js"></script></head><body><div id="content"><h1>Connect</h1><div id="exports.mime" class="comment"><h2>exports.mime()</h2><div class="description"><p>Extract the mime type from the given request's<br /><em>Content-Type</em> header.</p></div><ul class="tags"><li><em>IncomingMessage</em> req </li><li>returns <em>String</em> </li></ul><h3>Source</h3><pre><code>exports.mime = function(req) {
  var str = req.headers['content-type'] || '';
  return str.split(';')[0];
};</code></pre></div><div id="exports.error" class="comment"><h2>exports.error()</h2><div class="description"><p>Generate an <code>Error</code> from the given status <code>code</code>.</p></div><ul class="tags"><li><em>Number</em> code </li><li>returns <em>Error</em> </li></ul><h3>Source</h3><pre><code>exports.error = function(code){
  var err = new Error(http.STATUS_CODES[code]);
  err.status = code;
  return err;
};</code></pre></div><div id="exports.md5" class="comment"><h2>exports.md5()</h2><div class="description"><p>Return md5 hash of the given string and optional encoding,<br />defaulting to hex.</p>

<pre><code>utils.md5('wahoo');
// =&gt; "e493298061761236c96b02ea6aa8a2ad"
</code></pre></div><ul class="tags"><li><em>String</em> str </li><li><em>String</em> encoding </li><li>returns <em>String</em> </li></ul><h3>Source</h3><pre><code>exports.md5 = function(str, encoding){
  return crypto
    .createHash('md5')
    .update(str)
    .digest(encoding || 'hex');
};</code></pre></div><div id="exports.merge" class="comment"><h2>exports.merge()</h2><div class="description"><p>Merge object b with object a.</p>

<pre><code>var a = { foo: 'bar' }
  , b = { bar: 'baz' };

utils.merge(a, b);
// =&gt; { foo: 'bar', bar: 'baz' }
</code></pre></div><ul class="tags"><li><em>Object</em> a </li><li><em>Object</em> b </li><li>returns <em>Object</em> </li></ul><h3>Source</h3><pre><code>exports.merge = function(a, b){
  if (a && b) {
    for (var key in b) {
      a[key] = b[key];
    }
  }
  return a;
};</code></pre></div><div id="exports.escape" class="comment"><h2>exports.escape()</h2><div class="description"><p>Escape the given string of <code>html</code>.</p></div><ul class="tags"><li><em>String</em> html </li><li>returns <em>String</em> </li></ul><h3>Source</h3><pre><code>exports.escape = function(html){
  return String(html)
    .replace(/&(?!\w+;)/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
};</code></pre></div><div id="exports.uid" class="comment"><h2>exports.uid()</h2><div class="description"><p>Return a unique identifier with the given <code>len</code>.</p>

<pre><code>utils.uid(10);
// =&gt; "FDaS435D2z"
</code></pre></div><ul class="tags"><li><em>Number</em> len </li><li>returns <em>String</em> </li></ul><h3>Source</h3><pre><code>exports.uid = function(len) {
  return crypto.randomBytes(Math.ceil(len * 3 / 4))
    .toString('base64')
    .slice(0, len);
};</code></pre></div><div id="exports.sign" class="comment"><h2>exports.sign()</h2><div class="description"><p>Sign the given <code>val</code> with <code>secret</code>.</p></div><ul class="tags"><li><em>String</em> val </li><li><em>String</em> secret </li><li>returns <em>String</em> </li></ul><h3>Source</h3><pre><code>exports.sign = function(val, secret){
  return val + '.' + crypto
    .createHmac('sha1', secret)
    .update(val)
    .digest('base64')
    .replace(/=+$/, '');
};</code></pre></div><div id="exports.unsign" class="comment"><h2>exports.unsign()</h2><div class="description"><p>Unsign and decode the given <code>val</code> with <code>secret</code>,<br />returning <code>false</code> if the signature is invalid.</p></div><ul class="tags"><li><em>String</em> val </li><li><em>String</em> secret </li><li>returns <em>String | Boolean</em> </li></ul><h3>Source</h3><pre><code>exports.unsign = function(val, secret){
  var str = val.slice(0,val.lastIndexOf('.'));
  return exports.sign(str, secret) == val
    ? str
    : false;
};</code></pre></div><div id="exports.parseSignedCookies" class="comment"><h2>exports.parseSignedCookies()</h2><div class="description"><p>Parse signed cookies, returning an object<br />containing the decoded key/value pairs,<br />while removing the signed key from <code>obj</code>.</p></div><ul class="tags"><li><em>Object</em> obj </li><li>returns <em>Object</em> </li></ul><h3>Source</h3><pre><code>exports.parseSignedCookies = function(obj, secret){
  var ret = {};
  Object.keys(obj).forEach(function(key){
    var val = obj[key]
      , signed = exports.unsign(val, secret);

    if (signed) {
      ret[key] = signed;
      delete obj[key];
    }
  });
  return ret;
};</code></pre></div><div id="exports.parseJSONCookies" class="comment"><h2>exports.parseJSONCookies()</h2><div class="description"><p>Parse JSON cookies.</p></div><ul class="tags"><li><em>Object</em> obj </li><li>returns <em>Object</em> </li></ul><h3>Source</h3><pre><code>exports.parseJSONCookies = function(obj){
  Object.keys(obj).forEach(function(key){
    var val = obj[key];
    if (0 == val.indexOf('j:')) {
      try {
        obj[key] = JSON.parse(val.slice(2));
      } catch (err) {
        // nothing
      }
    }
  });
  return obj;
};</code></pre></div><div id="exports.parseCookie" class="comment"><h2>exports.parseCookie()</h2><div class="description"><p>Parse the given cookie string into an object.</p></div><ul class="tags"><li><em>String</em> str </li><li>returns <em>Object</em> </li></ul><h3>Source</h3><pre><code>exports.parseCookie = function(str){
  var obj = {}
    , pairs = str.split(/[;,] */);
  for (var i = 0, len = pairs.length; i < len; ++i) {
    var pair = pairs[i]
      , eqlIndex = pair.indexOf('=')
      , key = pair.substr(0, eqlIndex).trim()
      , val = pair.substr(++eqlIndex, pair.length).trim();

    // quoted values
    if ('"' == val[0]) val = val.slice(1, -1);

    // only assign once
    if (undefined == obj[key]) {
      val = val.replace(/\+/g, ' ');
      try {
        obj[key] = decodeURIComponent(val);
      } catch (err) {
        if (err instanceof URIError) {
          obj[key] = val;
        } else {
          throw err;
        }
      }
    }
  }
  return obj;
};</code></pre></div><div id="exports.serializeCookie" class="comment"><h2>exports.serializeCookie()</h2><div class="description"><p>Serialize the given object into a cookie string.</p>

<pre><code> utils.serializeCookie('name', 'tj', { httpOnly: true })
 // =&gt; "name=tj; httpOnly"
</code></pre></div><ul class="tags"><li><em>String</em> name </li><li><em>String</em> val </li><li><em>Object</em> obj </li><li>returns <em>String</em> </li></ul><h3>Source</h3><pre><code>exports.serializeCookie = function(name, val, obj){
  var pairs = [name + '=' + encodeURIComponent(val)]
    , obj = obj || {};

  if (obj.domain) pairs.push('domain=' + obj.domain);
  if (obj.path) pairs.push('path=' + obj.path);
  if (obj.expires) pairs.push('expires=' + obj.expires.toUTCString());
  if (obj.httpOnly) pairs.push('httpOnly');
  if (obj.secure) pairs.push('secure');

  return pairs.join('; ');
};</code></pre></div><div id="exports.pause" class="comment"><h2>exports.pause()</h2><div class="description"><p>Pause <code>data</code> and <code>end</code> events on the given <code>obj</code>.<br />Middleware performing async tasks <em>should</em> utilize<br />this utility (or similar), to re-emit data once<br />the async operation has completed, otherwise these<br />events may be lost.</p>

<pre><code> var pause = utils.pause(req);
 fs.readFile(path, function(){
    next();
    pause.resume();
 });
</code></pre></div><ul class="tags"><li><em>Object</em> obj </li><li>returns <em>Object</em> </li></ul><h3>Source</h3><pre><code>exports.pause = function(obj){
  var onData
    , onEnd
    , events = [];

  // buffer data
  obj.on('data', onData = function(data, encoding){
    events.push(['data', data, encoding]);
  });

  // buffer end
  obj.on('end', onEnd = function(data, encoding){
    events.push(['end', data, encoding]);
  });

  return {
    end: function(){
      obj.removeListener('data', onData);
      obj.removeListener('end', onEnd);
    },
    resume: function(){
      this.end();
      for (var i = 0, len = events.length; i < len; ++i) {
        obj.emit.apply(obj, events[i]);
      }
    }
  };
};</code></pre></div><div id="exports.modified" class="comment"><h2>exports.modified()</h2><div class="description"><p>Check <code>req</code> and <code>res</code> to see if it has been modified.</p></div><ul class="tags"><li><em>IncomingMessage</em> req </li><li><em>ServerResponse</em> res </li><li>returns <em>Boolean</em> </li></ul><h3>Source</h3><pre><code>exports.modified = function(req, res, headers) {
  var headers = headers || res._headers || {}
    , modifiedSince = req.headers['if-modified-since']
    , lastModified = headers['last-modified']
    , noneMatch = req.headers['if-none-match']
    , etag = headers['etag'];

  if (noneMatch) noneMatch = noneMatch.split(/ *, */);

  // check If-None-Match
  if (noneMatch && etag && ~noneMatch.indexOf(etag)) {
    return false;
  }

  // check If-Modified-Since
  if (modifiedSince && lastModified) {
    modifiedSince = new Date(modifiedSince);
    lastModified = new Date(lastModified);
    // Ignore invalid dates
    if (!isNaN(modifiedSince.getTime())) {
      if (lastModified <= modifiedSince) return false;
    }
  }
  
  return true;
};</code></pre></div><div id="exports.removeContentHeaders" class="comment"><h2>exports.removeContentHeaders()</h2><div class="description"><p>Strip <code>Content-*</code> headers from <code>res</code>.</p></div><ul class="tags"><li><em>ServerResponse</em> res </li></ul><h3>Source</h3><pre><code>exports.removeContentHeaders = function(res){
  Object.keys(res._headers).forEach(function(field){
    if (0 == field.indexOf('content')) {
      res.removeHeader(field);
    }
  });
};</code></pre></div><div id="exports.conditionalGET" class="comment"><h2>exports.conditionalGET()</h2><div class="description"><p>Check if <code>req</code> is a conditional GET request.</p></div><ul class="tags"><li><em>IncomingMessage</em> req </li><li>returns <em>Boolean</em> </li></ul><h3>Source</h3><pre><code>exports.conditionalGET = function(req) {
  return req.headers['if-modified-since']
    || req.headers['if-none-match'];
};</code></pre></div><div id="exports.unauthorized" class="comment"><h2>exports.unauthorized()</h2><div class="description"><p>Respond with 401 "Unauthorized".</p></div><ul class="tags"><li><em>ServerResponse</em> res </li><li><em>String</em> realm </li></ul><h3>Source</h3><pre><code>exports.unauthorized = function(res, realm) {
  res.statusCode = 401;
  res.setHeader('WWW-Authenticate', 'Basic realm="' + realm + '"');
  res.end('Unauthorized');
};</code></pre></div><div id="exports.notModified" class="comment"><h2>exports.notModified()</h2><div class="description"><p>Respond with 304 "Not Modified".</p></div><ul class="tags"><li><em>ServerResponse</em> res </li><li><em>Object</em> headers </li></ul><h3>Source</h3><pre><code>exports.notModified = function(res) {
  exports.removeContentHeaders(res);
  res.statusCode = 304;
  res.end();
};</code></pre></div><div id="exports.etag" class="comment"><h2>exports.etag()</h2><div class="description"><p>Return an ETag in the form of <code>"&lt;size&gt;-&lt;mtime&gt;"</code><br />from the given <code>stat</code>.</p></div><ul class="tags"><li><em>Object</em> stat </li><li>returns <em>String</em> </li></ul><h3>Source</h3><pre><code>exports.etag = function(stat) {
  return '"' + stat.size + '-' + Number(stat.mtime) + '"';
};</code></pre></div><div id="exports.parseRange" class="comment"><h2>exports.parseRange()</h2><div class="description"><p>Parse "Range" header <code>str</code> relative to the given file <code>size</code>.</p></div><ul class="tags"><li><em>Number</em> size </li><li><em>String</em> str </li><li>returns <em>Array</em> </li></ul><h3>Source</h3><pre><code>exports.parseRange = function(size, str){
  var valid = true;
  var arr = str.substr(6).split(',').map(function(range){
    var range = range.split('-')
      , start = parseInt(range[0], 10)
      , end = parseInt(range[1], 10);

    // -500
    if (isNaN(start)) {
      start = size - end;
      end = size - 1;
    // 500-
    } else if (isNaN(end)) {
      end = size - 1;
    }

    // Invalid
    if (isNaN(start) || isNaN(end) || start > end) valid = false;

    return { start: start, end: end };
  });
  return valid ? arr : undefined;
};</code></pre></div><div id="exports.parseCacheControl" class="comment"><h2>exports.parseCacheControl()</h2><div class="description"><p>Parse the given Cache-Control <code>str</code>.</p></div><ul class="tags"><li><em>String</em> str </li><li>returns <em>Object</em> </li></ul><h3>Source</h3><pre><code>exports.parseCacheControl = function(str){
  var directives = str.split(',')
    , obj = {};

  for(var i = 0, len = directives.length; i < len; i++) {
    var parts = directives[i].split('=')
      , key = parts.shift().trim()
      , val = parseInt(parts.shift(), 10);

    obj[key] = isNaN(val) ? true : val;
  }

  return obj;
};</code></pre></div><div id="toArray" class="comment"><h2>toArray</h2><div class="description"><p>Convert array-like object to an <code>Array</code>.</p>

<p>node-bench measured "16.5 times faster than Array.prototype.slice.call()"</p></div><ul class="tags"><li><em>Object</em> obj </li><li>returns <em>Array</em> </li></ul><h3>Source</h3><pre><code>var toArray = exports.toArray = function(obj){
  var len = obj.length
    , arr = new Array(len);
  for (var i = 0; i < len; ++i) {
    arr[i] = obj[i];
  }
  return arr;
};</code></pre></div></div><ul id="menu"><li><a href="#exports.mime">exports.mime()</a></li><li><a href="#exports.error">exports.error()</a></li><li><a href="#exports.md5">exports.md5()</a></li><li><a href="#exports.merge">exports.merge()</a></li><li><a href="#exports.escape">exports.escape()</a></li><li><a href="#exports.uid">exports.uid()</a></li><li><a href="#exports.sign">exports.sign()</a></li><li><a href="#exports.unsign">exports.unsign()</a></li><li><a href="#exports.parseSignedCookies">exports.parseSignedCookies()</a></li><li><a href="#exports.parseJSONCookies">exports.parseJSONCookies()</a></li><li><a href="#exports.parseCookie">exports.parseCookie()</a></li><li><a href="#exports.serializeCookie">exports.serializeCookie()</a></li><li><a href="#exports.pause">exports.pause()</a></li><li><a href="#exports.modified">exports.modified()</a></li><li><a href="#exports.removeContentHeaders">exports.removeContentHeaders()</a></li><li><a href="#exports.conditionalGET">exports.conditionalGET()</a></li><li><a href="#exports.unauthorized">exports.unauthorized()</a></li><li><a href="#exports.notModified">exports.notModified()</a></li><li><a href="#exports.etag">exports.etag()</a></li><li><a href="#exports.parseRange">exports.parseRange()</a></li><li><a href="#exports.parseCacheControl">exports.parseCacheControl()</a></li><li><a href="#toArray">toArray</a></li></ul></body></html>