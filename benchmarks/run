#!/usr/bin/env bash

ABFLAGS=${ABFLAGS-"-n 2000 -c 50 -k"}
ADDR=${ADDR-http://0.0.0.0:3000/}
AB=${AB-ab}

#
# Log <msg ...>
# 
# <msg ...>
#

log(){
  echo "... $@"
}

#
# Benchmark the given <dir>.
# 
# <dir>
#

bm(){
  local dir=$1;
	for file in benchmarks/$dir/*; do
		log running $file
		case $file in
			*.js)
			  node $file &
			  sleep 1
			  ;;
			*.thin.ru)
			  thin -R $file -p 3000 start &
			  sleep 2
			  ;;
		esac
		local pid=$!
		local dirname=results/$(dirname $file)
		mkdir -p $dirname
		$AB $ABFLAGS -g results/$file.dat $ADDR > results/$file.out
		log $(cat results/$file.out | grep Requests)
		kill -9 $pid
	done
}

# Make ./results
mkdir -p results

# Store flags
echo $ABFLAGS > results/flags

# Run benchmarks
log $AB $ABFLAGS $ADDR
bm hello-world