<!DOCTYPE html><html><head><title>Connect - High quality middleware for node.js</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><link rel="stylesheet" href="style.css"><script src="jquery.js"></script><script src="docs.js"></script></head><body><div id="content"><h1>Connect</h1><p>High quality middleware for Node.js</p><a href="http://github.com/senchalabs/connect"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/assets.github.com/img/7afbc8b248c68eb468279e8c17986ad46549fb71/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub"></a>
<div id="module.exports" class="comment"><h2></h2><div class="description"><h2>Profiler</h2>

<p>Profile the duration of a request.</p>

<p>Typically this middleware should be utilized<br /><em>above</em> all others, as it proxies the <code>res.end()</code><br />method, being first allows it to encapsulate all<br />other middleware.</p>

<h2>Example Output</h2>

<pre><code> GET /
 response time 2ms
 memory rss 52.00kb
 memory vsize 2.07mb
 heap before 3.76mb / 8.15mb
 heap after 3.80mb / 8.15mb
</code></pre></div><ul class="tags"></ul><h3>Source</h3><pre><code>module.exports = function profiler(){
  return function(req, res, next){
    var end = res.end
      , start = snapshot();

    // state snapshot
    function snapshot() {
      return {
          mem: process.memoryUsage()
        , time: new Date
      };
    }

    // proxy res.end()
    res.end = function(data, encoding){
      res.end = end;
      res.end(data, encoding);
      compare(req, start, snapshot())
    };

    next();
  }
};</code></pre></div><div id="compare" class="comment"><h2>compare()</h2><div class="description"><p>Compare <code>start</code> / <code>end</code> snapshots.</p></div><ul class="tags"><li><em>IncomingRequest</em> req </li><li><em>Object</em> start </li><li><em>Object</em> end </li></ul><h3>Source</h3><pre><code>function compare(req, start, end) {
  console.log();
  row(req.method, req.url);
  row('response time:', (end.time - start.time) + 'ms');
  row('memory rss:', formatBytes(end.mem.rss - start.mem.rss));
  row('heap before:', formatBytes(start.mem.heapUsed) + ' / ' + formatBytes(start.mem.heapTotal));
  row('heap after:', formatBytes(end.mem.heapUsed) + ' / ' + formatBytes(end.mem.heapTotal));
  console.log();
}</code></pre></div><div id="row" class="comment"><h2>row()</h2><div class="description"><p>Row helper</p></div><ul class="tags"><li><em>String</em> key </li><li><em>String</em> val </li></ul><h3>Source</h3><pre><code>function row(key, val) {
  console.log('  \033[90m%s\033[0m \033[36m%s\033[0m', key, val);
}</code></pre></div><div id="formatBytes" class="comment"><h2>formatBytes()</h2><div class="description"><p>Format byte-size.</p></div><ul class="tags"><li><em>Number</em> bytes </li><li>returns <em>String</em> </li></ul><h3>Source</h3><pre><code>function formatBytes(bytes) {
  var kb = 1024
    , mb = 1024 * kb
    , gb = 1024 * mb;
  if (bytes < kb) return bytes + 'b';
  if (bytes < mb) return (bytes / kb).toFixed(2) + 'kb';
  if (bytes < gb) return (bytes / mb).toFixed(2) + 'mb';
  return (bytes / gb).toFixed(2) + 'gb';
};</code></pre></div></div><ul id="menu"><li><a href="#module.exports"></a></li><li><a href="#compare">compare()</a></li><li><a href="#row">row()</a></li><li><a href="#formatBytes">formatBytes()</a></li></ul></body></html>