<html>
  <head>
    <title>
      
        Connect - logger
      
    </title>
    <link rel='stylesheet' href='main.css' />
  </head>
  <body>
    <div id="content">
      
        <h1>logger</h1>
        <span class="filename">lib/middleware/logger.js</span>
      

      
      
        
        
        
        
        
          <div class="comment">
            
            <p class="description"><p>Log requests with the given <code>options</code> or a <code>format</code> string.</p></p>

            
              <div class="body">
                <h2>Options</h2>

<ul><li><code>format</code>  Format string, see below for tokens</li><li><code>stream</code>  Output stream, defaults to <em>stdout</em></li><li><code>buffer</code>  Buffer duration, defaults to 1000ms when <em>true</em></li></ul>

<h2>Tokens</h2>

<ul><li><code>:req[header]</code> ex: <code>:req[Accept]</code></li><li><code>:res[header]</code> ex: <code>:res[Content-Length]</code></li><li><code>:http-version</code></li><li><code>:response-time</code></li><li><code>:remote-addr</code></li><li><code>:date</code></li><li><code>:method</code></li><li><code>:url</code></li><li><code>:referrer</code></li><li><code>:user-agent</code></li><li><code>:status</code></li></ul>
              </div>
            

            
              <ul class="tags">
              
                

                

                

                
                  <li class="param"><em>param</em> <span class="types">String, Object</span> <span class="name">format</span> <span class="description">or options</span></li>
                
              
                
                  <li class="return"><em>returns</em> <span class="types">Function</span></li>
                

                

                

                
              
                

                
                  <li class="api"><em>api</em> <span class="visibility">public</span></li>
                

                

                
              
              </ul>

<!--            
              <pre class="code">
                <code>
<span class="variable">module</span>.<span class="variable">exports</span> = <span class="keyword">function</span> <span class="variable">logger</span>(<span class="variable">options</span>) {
  <span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> <span class="variable">options</span>) {
    <span class="variable">options</span> = { <span class="variable">format</span>: <span class="variable">options</span> };
  } <span class="keyword">else</span> {
    <span class="variable">options</span> = <span class="variable">options</span> || {};
  }

  <span class="keyword">var</span> <span class="variable">fmt</span> = <span class="variable">options</span>.<span class="variable">format</span>
    , <span class="variable">stream</span> = <span class="variable">options</span>.<span class="variable">stream</span> || <span class="variable">process</span>.<span class="variable">stdout</span>
    , <span class="variable">buffer</span> = <span class="variable">options</span>.<span class="variable">buffer</span>;

  <span class="comment">// buffering support</span>
  <span class="keyword">if</span> (<span class="variable">buffer</span>) {
    <span class="keyword">var</span> <span class="variable">realStream</span> = <span class="variable">stream</span>
      , <span class="variable">interval</span> = <span class="string">'number'</span> == <span class="keyword">typeof</span> <span class="variable">buffer</span>
        ? <span class="variable">buffer</span>
        : <span class="variable">defaultBufferDuration</span>;

    <span class="comment">// flush interval</span>
    <span class="variable">setInterval</span>(<span class="keyword">function</span>(){
      <span class="keyword">if</span> (<span class="variable">buf</span>.<span class="variable">length</span>) {
        <span class="variable">realStream</span>.<span class="variable">write</span>(<span class="variable">buf</span>.<span class="variable">join</span>(<span class="string">''</span>), <span class="string">'ascii'</span>);
        <span class="variable">buf</span>.<span class="variable">length</span> = <span class="number integer">0</span>;
      }
    }, <span class="variable">interval</span>); 

    <span class="comment">// swap the stream</span>
    <span class="variable">stream</span> = {
      <span class="variable">write</span>: <span class="keyword">function</span>(<span class="variable">str</span>){
        <span class="variable">buf</span>.<span class="variable">push</span>(<span class="variable">str</span>);
      }
    };
  }

  <span class="keyword">return</span> <span class="keyword">function</span> <span class="variable">logger</span>(<span class="variable">req</span>, <span class="variable">res</span>, <span class="variable">next</span>) {
    <span class="keyword">var</span> <span class="variable">start</span> = +<span class="keyword">new</span> <span class="class">Date</span>
      , <span class="variable">statusCode</span>
      , <span class="variable">resHeaders</span>
      , <span class="variable">writeHead</span> = <span class="variable">res</span>.<span class="variable">writeHead</span>
      , <span class="variable">end</span> = <span class="variable">res</span>.<span class="variable">end</span>
      , <span class="variable">url</span> = <span class="variable">req</span>.<span class="variable">url</span>;

    <span class="comment">// mount safety</span>
    <span class="keyword">if</span> (<span class="variable">req</span>.<span class="variable">_logging</span>) <span class="keyword">return</span> <span class="variable">next</span>();

    <span class="comment">// flag as logging</span>
    <span class="variable">req</span>.<span class="variable">_logging</span> = <span class="variable">true</span>;

    <span class="comment">// proxy for statusCode.</span>
    <span class="variable">res</span>.<span class="variable">writeHead</span> = <span class="keyword">function</span>(<span class="variable">code</span>, <span class="variable">headers</span>){
      <span class="variable">res</span>.<span class="variable">writeHead</span> = <span class="variable">writeHead</span>;
      <span class="variable">res</span>.<span class="variable">writeHead</span>(<span class="variable">code</span>, <span class="variable">headers</span>);
      <span class="variable">res</span>.<span class="variable">_statusCode</span> = <span class="variable">statusCode</span> = <span class="variable">code</span>;
      <span class="variable">res</span>.<span class="variable">_headers</span> = <span class="variable">resHeaders</span> = <span class="variable">headers</span> || {};
    };

    <span class="comment">// proxy end to output a line to the provided logger.</span>
    <span class="keyword">if</span> (<span class="variable">fmt</span>) {
      <span class="variable">res</span>.<span class="variable">end</span> = <span class="keyword">function</span>(<span class="variable">chunk</span>, <span class="variable">encoding</span>) {
        <span class="variable">res</span>.<span class="variable">end</span> = <span class="variable">end</span>;
        <span class="variable">res</span>.<span class="variable">end</span>(<span class="variable">chunk</span>, <span class="variable">encoding</span>);
        <span class="variable">res</span>.<span class="variable">responseTime</span> = +<span class="keyword">new</span> <span class="class">Date</span> - <span class="variable">start</span>;
        <span class="variable">stream</span>.<span class="variable">write</span>(<span class="variable">format</span>(<span class="variable">fmt</span>, <span class="variable">req</span>, <span class="variable">res</span>) + <span class="string">'\n'</span>, <span class="string">'ascii'</span>);
      };
    } <span class="keyword">else</span> {
      <span class="variable">res</span>.<span class="variable">end</span> = <span class="keyword">function</span>(<span class="variable">chunk</span>, <span class="variable">encoding</span>) {
        <span class="variable">res</span>.<span class="variable">end</span> = <span class="variable">end</span>;
        <span class="variable">res</span>.<span class="variable">end</span>(<span class="variable">chunk</span>, <span class="variable">encoding</span>);

        <span class="variable">stream</span>.<span class="variable">write</span>((<span class="variable">req</span>.<span class="variable">socket</span> && <span class="variable">req</span>.<span class="variable">socket</span>.<span class="variable">remoteAddress</span>)
           + <span class="string">' - - ['</span> + (<span class="keyword">new</span> <span class="class">Date</span>).<span class="variable">toUTCString</span>() + <span class="string">']'</span>
           + <span class="string">' "'</span> + <span class="variable">req</span>.<span class="variable">method</span> + <span class="string">' '</span> + <span class="variable">url</span>
           + <span class="string">' HTTP/'</span> + <span class="variable">req</span>.<span class="variable">httpVersionMajor</span> + <span class="string">'.'</span> + <span class="variable">req</span>.<span class="variable">httpVersionMinor</span> + <span class="string">'" '</span>
           + <span class="variable">statusCode</span> + <span class="string">' '</span> + (<span class="variable">resHeaders</span>[<span class="string">'Content-Length'</span>] || <span class="string">'-'</span>)
           + <span class="string">' "'</span> + (<span class="variable">req</span>.<span class="variable">headers</span>[<span class="string">'referer'</span>] || <span class="variable">req</span>.<span class="variable">headers</span>[<span class="string">'referrer'</span>] || <span class="string">''</span>)
           + <span class="string">'" "'</span> + (<span class="variable">req</span>.<span class="variable">headers</span>[<span class="string">'user-agent'</span>] || <span class="string">''</span>) + <span class="string">'"\n'</span>, <span class="string">'ascii'</span>);
      };
    }

    <span class="variable">next</span>();
  };
};
                </code>
              </pre>
             -->
          
          </div>
        
      
        
      
    </div>
  </body>
</html>